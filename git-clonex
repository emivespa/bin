#!/usr/bin/env bash
#
# - organize your git clones
#
# git clonex $clonex_opts $url $clone_opts
#
# git clonex     git:r.e:p/o.git == git clone git:r.e:p/o.git ~/src/r.e/p/o.git
# git clonex     https://r.e/p/o == git clone https://a.b/c/d ~/src/r.e/p/o
# git clonex -r  https://r.e/p/o == git clone https://a.b/c/d ./r.e/p/o
set -eu -o pipefail

command -v git >/dev/null 2>&1 || exit 1

mode='absolute'
case "$1" in
	('-r')
		mode='relative'
		shift
		;;
	('--tmp')
		mode='tmp'
		shift
		;;
	(*)
		;;
esac

url="$1"; shift

case "$url" in
	(*'://'*)
		dir="${url#*://}"
		;;
	('git@'*)
		dir="${url#*@}"
		dir="${url/:/\/}" # FIXME: bashism.
		;;
	(*)
		dir="${url/:/\/}" # FIXME: bashism.
		;;
esac

case "$mode" in
	('absolute') dir="${HOME}/src/${dir}" ;;
	('relative') dir="./${dir}" ;;
	('tmp') dir="/tmp/${USER}/${dir}" ;;
	(*) exit 1 ;;
esac

git clone ${1+"$@"} --depth 1 "$url" "$dir" || ex="$?"
	# If clone fails, we still want to copy the directory to the clipboard,
	# but remember the exit code so we can exit with it later.
echo "${dir}" | clipe
if test "${ex-}" != ''; then
	exit "$ex"
fi
